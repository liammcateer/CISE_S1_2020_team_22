<!DOCTYPE html>
<html>

<head>

    <!-- import bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- import Jquery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <!-- styles for the elements on this page -->
    <style>
        /* center the container */
        #searchinput {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 50vh;
        }

        /* search field */
        #keywords {
            padding: 12px;
            margin: 10px;
            border: 1px solid rgb(155, 155, 155);
            border-radius: 4px;
            box-sizing: border-box;
            width: 500px;

        }

        /* align the button to the search input */
        #mainButton {
            position: relative;
            bottom: 2px;
            padding: 12px;

        }

        /* advance search link */
        #link {
            position: relative;
            top: 15px;
        }

        /* advance search whole*/
        #details {
            position: relative;
            width: 800px;
            left: 20px;
        }


        div.conditions {
            border: 1px solid lightgrey;
            padding: 5px;
        }



        label.iflabel {
            font-weight: bold;
            font-size: large;
            position: relative;
            top: 8px;
        }


        #inputvalue {
            position: relative;
            line-height: 32px;
        }


        .addButton {
            position: relative;
            border: 0;
            height: 37px;

        }

        .deleteButton {
            position: relative;
            border: 0;
            height: 37px;

        }
    </style>
    <title>Searcher-form</title>
</head>

<body>
    <!-- Navigation bar -->
    <nav></nav>

    <!-- search field -->
    <div id="searchinput" class="container" style="margin-top:80px">

        <!-- We could put our logo here -->
        <div>
            <!-- <img src="background.jpg" width:100 height:100 alt="log"/> -->
        </div>

        <form id="mainsearchform">

            <!-- searcher box -->

            <label for="keywords">Descriptions:</label>
            <input type="text" class="textInput" name="keywords" id="keywords" placeholder="Seer it!" required />
            <!-- change the submit type to button, otherwise will keep refreshing the page -->
            <input id="mainButton" class="btn btn-primary" type="submit" name="Search" value="Search"
                onclick="getResult()" />
        </form>

        <!-- sort options -->
        <div>
            <div class="form-check-inline">
                <label class="form-check-label">
                    <input type="radio" class="form-check-input" name="sort" value="year">By publish year
                </label>
            </div>
            <div class="form-check-inline">
                <label class="form-check-label">
                    <input type="radio" class="form-check-input" name="sort" value="rating">By rating
                </label>
            </div>
            <div class="form-check-inline disabled">
                <label class="form-check-label">
                    <input type="radio" class="form-check-input" name="sort" value="author">By author name
                </label>
            </div>
        </div>

        <a id="link" href="#">Advance search</a>
        <br>
        <br>




        <form id="details" style="display:none">
            <div id="allElements">

                <br>
                <br>

                <!-- date range div -->
                <div class="conditions">
                    <div class="row no-gutters">

                        <div class="col-sm-3">
                            <label class="iflabel">Date Range from</label>
                        </div>

                        <div class="col-sm-4">
                            <input class="form-control start_date" type="text" style="position: relative"
                                placeholder="start year" id="startdate">
                        </div>

                        <div class="col-sm-1">
                            <label class="iflabel">to</label>
                        </div>

                        <div class="col-sm-4">
                            <input class="form-control end_date" type="text" style="position: relative"
                                placeholder="end year" id="enddate">
                        </div>
                    </div><!-- end of row -->
                </div>

                <br>
                <br>

                <!-- multiple conditions -->
                <div class="conditions" id="constrains">
                    <div class="row no-gutters">

                        <div class="col-sm-1">
                            <label class="iflabel">If</label>
                        </div>

                        <div class="col-sm-4">

                            <select class="custom-select subject" required>
                                <option selected value="">Name of Field</option>
                                <option value="author">Author</option>
                                <option value="title">Article title</option>
                                <option value="doi">Article source</option>
                                <option value="benefit">Benefit</option>
                                <option value="method">Method</option>
                                <option value="participants">Participants</option>
                            </select>
                        </div>

                        <div class="col-sm-3">
                            <select class="custom-select operator" required>
                                <option selected value="">Operator</option>
                                <option value="contain">Contains</option>
                                <option value="notinclude">Does Not Contain</option>
                                <option value="begin">Begins with</option>
                                <option value="end">Ends With</option>
                            </select>
                        </div>

                        <div class="col-sm-3">
                            <input class="inputvalueclass" id="inputvalue" type="text" placeholder="value" required />
                        </div>

                        <div class="col-sm-1 btn-group">
                            <input class="btn btn-success addButton" type="button" value="+" id="add">
                        </div>
                    </div><!-- end of row -->
                </div>
            </div>

        </form>


        <div id="result">
        </div>

    </div> <!-- end of container -->

    <script>

        $(document).ready(function () {

            var $allElements = $('allElements');

            // prevent page refresh after clicking submit type button
            $("#mainsearchform").submit(function (e) {
                e.preventDefault();

            });

            $("#details").submit(function (e) {
                e.preventDefault();

            });


            //change the word of the link, switch between "simple search" and "advance search".
            let count = 0;
            $("#link").click(function () {
                count++;
                if (count % 2 != 0) {
                    $("#link").text("Back to Simple Search");
                    $("#details").fadeOut();
                    $("#keywords").prop('disabled', true);
                }
                else {
                    $("#link").text("Advance Search");
                    $("#details").fadeIn();
                    $("#keywords").prop('disabled', false);
                }

                $("#details").slideToggle();

            });

            //will only fetch year from the calender
            $("#startdate").datepicker({
                autoclose: true,
                format: " yyyy",
                viewMode: "years",
                minViewMode: "years",
                startDate: '1900',
                endDate: new Date(),
            });;
            $("#enddate").datepicker({
                autoclose: true,
                format: " yyyy",
                viewMode: "years",
                minViewMode: "years",
                startDate: '1900',
                endDate: new Date(),
            });;

            //add the search condition as a variable
            var searchConditions =
                '<div class="conditions" id = "constrains">'
                + '<div class="row no-gutters">'
                + ' <div class="col-sm-1">'
                + ' <label class="iflabel">If</label>'
                + ' </div>'
                + ' <div class="col-sm-4">'
                + ' <select class="custom-select subject" >'
                + ' <option selected value="">Name of Field</option>'
                + ' <option value="author">Author</option>'
                + ' <option value="article">Article title</option>'
                + ' <option value="source">Article source</option>'
                + '<option value="benefit">Benefit</option>'
                + '<option value="method">Method</option>'
                + '<option value="participants">Participants</option>'
                + '  </select>'
                + ' </div>'
                + ' <div class="col-sm-3">'
                + ' <select class="custom-select operator">'
                + '<option selected value="">Operator</option>'
                + '<option value="c">Contains</option>'
                + '<option value="d">Does Not Contain</option>'
                + '<option value="b">Begins with</option>'
                + '<option value="e">Ends With</option>'
                + ' </select>'
                + ' </div>'
                + '<div class="col-sm-3">'
                + ' <input type="text" id="inputvalue" placeholder="value" class="inputvalueclass">'
                + '</div>'
                + '<div class="col-sm-1 btn-group">'
                + '<input class="btn btn-success addButton" type="button" value="+" id="add">'
                + '<input class="btn btn-danger deleteButton" type="button" value="-" id="delete">'
                + '</div>'
                + '</div><!-- end of row -->'
                + '</div>';

            //apend new constains everytime click on add       
            $(document).on('click', '.addButton', function (e) {
                $('#allElements').append(
                    searchConditions
                )
            });

            $(document).on('click', '.deleteButton', function (e) {
                removeCurrent($(this))
            });



        })

        /* global variables below
        ---------------------------------------------------------------------------------------------
        */
        var keywords;
        var linkValue;
        var startDate;
        var endDate;
        var allSubject;
        var subject = [];
        var allOperator;
        var operator = [];
        var allValueInputs;
        var inputs = [];
        var url;
        var count = 0;
        var searchTotal = "";
        var sortCriterial = "";

        /* global variables above
       ---------------------------------------------------------------------------------------------
       */

        //get the sort criterial
        function getSortConditions() {
            var ele = document.getElementsByName('sort');

            for (i = 0; i < ele.length; i++) {
                if (ele[i].checked) {
                    sortCriterial = ele[i].value
                };
            }
        }
        //remove the condition filter.
        function removeCurrent(thisObj) {
            thisObj.parent().parent().parent().remove();
        }

        function fetchValues() {

            keywords = document.getElementById("keywords").value;
            linkValue = document.getElementById("link").innerHTML;

            //get date
            startDate = document.getElementById("startdate").value;
            endDate = document.getElementById("enddate").value;

            //get subject
            allSubject = document.getElementsByClassName("subject");
            for (var i = 0; i < allSubject.length; i++) {
                if (typeof allSubject[i].value !== "undefined") {
                    subject.push(allSubject[i].value);
                }
            }

            //get operator
            allOperator = document.getElementsByClassName("operator");
            for (var i = 0; i < allOperator.length; i++) {
                if (typeof allOperator[i].value !== "undefined") {
                    operator.push(allOperator[i].value);
                }
            }

            //get inputs
            allValueInputs = document.getElementsByClassName("inputvalueclass");
            for (var i = 0; i < allValueInputs.length; i++) {
                if (typeof allValueInputs[i].value !== "undefined") {
                    inputs.push(allValueInputs[i].value);
                }
            }

        }

        function customizeURL() {

            //if use the simple search
            if (linkValue == "Advance search") {
                return url = "/api/v1/article";
            }

            getSortConditions();
            url = "/api/v1/article?";

            if (startDate != "") {
                url += "year[gte]=" + startDate;
            }

            if (endDate != "") {
                url += "&year[lte]=" + endDate;
            }

            if (sortCriterial != "") {
                url += "&sort=" + sortCriterial;
            }
            return url;
        }



        //Search button on click function
        function getResult() {

            // get all the values from inputs
            fetchValues();
            //get table result
            getTable();
        }

        function getTable() {

            //Dont include the IP!!!!!!
            $.getJSON(customizeURL(), function (data) {
                var article = data["data"]["article"];
                var result = "";
                count++;
                var query = ""

                //simple search
                if (linkValue == "Advance search") {
                    document.getElementById("result").insertAdjacentHTML('beforeend',keywords);
                }

                //advance search
                else {

                    //input validation
                    if (parseInt(startDate) > parseInt(endDate)) {
                        alert("start year cannot be bigger than end year");
                    }

                    //if valid
                    else {

                        //remove empty element in the related array  
                        subject.map(e => {

                            if (e == "") {
                                operator.splice(subject.indexOf(e), 1);
                                inputs.splice(subject.indexOf(e), 1);
                            }
                        })
                        subject = subject.filter(e => {
                            return e != "";
                        })

                        operator.map(e => {
                            if (e == "") {
                                subject.splice(operator.indexOf(e), 1);
                                inputs.splice(operator.indexOf(e), 1);
                            }
                        })
                        operator = operator.filter(e => {
                            return e != "";
                        })


                        inputs.map(e => {
                            if (e == "") {
                                operator.splice(inputs.indexOf(e), 1);
                                subject.splice(inputs.indexOf(e), 1);
                            }
                        })
                        inputs = inputs.filter(e => {
                            return e != "";
                        })

                    }
                

                for (let i = 0; i < subject.length; i++) {
                    query += subject[i] + " " + operator[i] + " " + inputs[i];
                }
                result += "<p>This is your <strong><i>" + count + "</i></strong> time(s) of search<br>";
                result += "You searched for aticles from " + startDate + " to" + endDate + " where " + query + "</p>";
                result += "<table class='table table-striped'>"
                    + "<tr>"
                    + "<th>Title</th>"
                    + "<th>Author</th>"
                    + "<th>Year</th>"
                    + "<th>Rate</th>"
                    + "<th>DOI</th>"
                    + "</tr>"

                for (let i = 0; i < article.length; i++) {

                    result += "<tr>"
                        + "<td>" + article[i]["title"] + "</td>"
                        + "<td>" + article[i]["author"] + "</td>"
                        + "<td>" + article[i]["year"] + "</td>"
                        + "<td>pending...</td>"
                        + "<td>pending...</td>"
                        + "<tr>"

                }

                result += "</table>";
                result += "<br>";
                result += "<br>";

                //if no result
                if (article.length == 0) {
                    document.getElementById("result").insertAdjacentHTML('beforeend', "<p style='color:red'>Sorry, no result</p>");
                }

                //populate the result in a table.
                else {
                    document.getElementById("result").insertAdjacentHTML('beforeend', result);
                }

            }
            })

        }//end of the function
    </script>

    <!-- Include Bootstrap Datepicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.min.css" />
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>



</body>

</html>